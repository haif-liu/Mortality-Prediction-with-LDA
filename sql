
--Copy entire note events

\copy (WITH tmp as (SELECT adm.subject_id AS subject_id, adm.hadm_id AS hadm_id, admittime, dischtime, adm.deathtime,pat.gender AS gender, pat.dob AS dob, pat.dod AS dod, ROW_NUMBER() OVER (PARTITION BY hadm_id ORDER BY admittime DESC) AS mostrecent FROM admissions adm INNER JOIN patients pat ON adm.subject_id = pat.subject_id WHERE lower(diagnosis) NOT LIKE '%organ donor%' AND extract(YEAR FROM admittime) - extract(YEAR FROM dob) > 15 AND HAS_CHARTEVENTS_DATA = 1) SELECT tmp.subject_id AS SUBJECT_ID, tmp.hadm_id AS HADM_ID , chartdate, charttime, storetime, category, description, regexp_replace(noteevents.text, E'[\\n\\r]+', ' ', 'g' ) as docs FROM tmp INNER JOIN noteevents ON tmp.hadm_id = noteevents.hadm_id INNER JOIN icustays ON icustays.hadm_id = tmp.hadm_id WHERE charttime < icustays.intime + interval '5' day AND charttime < icustays.outtime) TO 'notesicu.csv' DELIMITER ',' CSV HEADER


--Copy ICU Notes for 120 hours

\copy (WITH tmp as (SELECT adm.subject_id AS subject_id, adm.hadm_id AS hadm_id, admittime, dischtime, adm.deathtime,pat.gender AS gender, pat.dob AS dob, pat.dod AS dod, ROW_NUMBER() OVER (PARTITION BY hadm_id ORDER BY admittime DESC) AS mostrecent FROM admissions adm INNER JOIN patients pat ON adm.subject_id = pat.subject_id WHERE lower(diagnosis) NOT LIKE '%organ donor%' AND extract(YEAR FROM admittime) - extract(YEAR FROM dob) > 15 AND HAS_CHARTEVENTS_DATA = 1) SELECT tmp.subject_id AS SUBJECT_ID, tmp.hadm_id AS HADM_ID , chartdate, charttime, storetime, category, description, regexp_replace(noteevents.text, E'[\\n\\r]+', ' ', 'g' ) as docs FROM tmp INNER JOIN noteevents ON tmp.hadm_id = noteevents.hadm_id INNER JOIN icustays ON icustays.hadm_id = tmp.hadm_id WHERE charttime > icustays.intime AND charttime < icustays.intime + interval '5' day AND charttime < icustays.outtime AND noteevents.category not like '%discharge%') TO 'notesicu.csv' DELIMITER ',' CSV HEADER

--Copy Charttime for each HADM

\copy (WITH tmp as (SELECT adm.subject_id AS subject_id, adm.hadm_id AS hadm_id, admittime, dischtime, adm.deathtime,pat.gender AS gender, pat.dob AS dob, pat.dod AS dod, ROW_NUMBER() OVER (PARTITION BY hadm_id ORDER BY admittime DESC) AS mostrecent FROM admissions adm INNER JOIN patients pat ON adm.subject_id = pat.subject_id WHERE lower(diagnosis) NOT LIKE '%organ donor%' AND extract(YEAR FROM admittime) - extract(YEAR FROM dob) > 15 AND HAS_CHARTEVENTS_DATA = 1) SELECT tmp.subject_id AS SUBJECT_ID, tmp.hadm_id AS HADM_ID , chartdate, charttime, storetime, category, description, regexp_replace(noteevents.text, E'[\\n\\r]+', ' ', 'g' ) as docs FROM tmp INNER JOIN (WITH summary AS (SELECT *, ROW_NUMBER() OVER(PARTITION BY p.hadm_id ORDER BY p.charttime ASC) AS rk FROM noteevents p) SELECT s.* FROM summary s) as noteevents ON tmp.hadm_id = noteevents.hadm_id WHERE charttime < tmp.admittime + interval '5' day) TO 'notes5.csv' DELIMITER ',' CSV HEADER


--Copy ICU Notes for 120 hours

\copy (WITH tmp as (SELECT adm.subject_id AS subject_id, adm.hadm_id AS hadm_id, admittime, dischtime, adm.deathtime,pat.gender AS gender, pat.dob AS dob, pat.dod AS dod, ROW_NUMBER() OVER (PARTITION BY hadm_id ORDER BY admittime DESC) AS mostrecent FROM admissions adm INNER JOIN patients pat ON adm.subject_id = pat.subject_id WHERE lower(diagnosis) NOT LIKE '%organ donor%' AND extract(YEAR FROM admittime) - extract(YEAR FROM dob) > 15 AND HAS_CHARTEVENTS_DATA = 1) SELECT tmp.subject_id AS SUBJECT_ID, tmp.hadm_id AS HADM_ID , chartdate, charttime, storetime, category, description, regexp_replace(noteevents.text, E'[\\n\\r]+', ' ', 'g' ) as docs FROM tmp INNER JOIN noteevents ON tmp.hadm_id = noteevents.hadm_id INNER JOIN icustays ON icustays.hadm_id = tmp.hadm_id WHERE charttime < icustays.intime + interval '5' day AND icustays.outtime > icustays.intime + interval '5' day AND noteevents.category not like '%discharge%') TO 'notesicurefine.csv' DELIMITER ',' CSV HEADER
